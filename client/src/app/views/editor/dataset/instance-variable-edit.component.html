<ng-container *ngIf="instanceVariable; else loadingInstanceVariable;">

  <div class="row">
    <div class="col-xs-12">
      <h1 *ngIf="instanceVariable.id; else newInstanceVariable;">
        {{ instanceVariable.prefLabel | lang }}
      </h1>
      <ng-template #newInstanceVariable>
        <h1>{{ 'newInstanceVariable' | translate }}</h1>
      </ng-template>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="prefLabel">{{ 'prefLabel' | translate }}</label>
        <input [(ngModel)]="instanceVariable.prefLabel[language]"
          id="prefLabel"
          name="prefLabel"
          type="text"
          class="form-control">
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="technicalName" translate="technicalName"></label>
        <input [(ngModel)]="instanceVariable.technicalName"
          id="technicalName"
          name="technicalName"
          type="text"
          class="form-control">
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="description">{{ 'description' | translate }}</label>
        <textarea [(ngModel)]="instanceVariable.description[language]"
          thlAutogrow
          id="description"
          name="description"
          class="form-control"
          rows="3">
        </textarea>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="conceptsFromScheme">{{ 'conceptsFromScheme' | translate }}</label>
        <br>
        <p-autoComplete
          [(ngModel)]="instanceVariable.conceptsFromScheme"
          [suggestions]="conceptSearchResults"
          (completeMethod)="searchConcept($event)"
          [multiple]="true"
          dataKey="id"
          emptyMessage="{{ 'noMatchingConcepts' | translate }}"
          placeholder="{{ 'conceptsFromSchemePlaceholder' | translate }}"
          minlength="3"
          inputId="conceptsFromScheme">

          <ng-template let-concept pTemplate="item">
            <span>
              {{ concept.prefLabel | lang }}
            </span>
            <small style="opacity:.7">
              <span *ngFor="let lang of getConceptLanguages(concept)">
                {{ lang }}:
                {{ concept.prefLabel[lang] }}
              </span>
              ({{ concept.conceptScheme.prefLabel | lang }})
            </small>
          </ng-template>

          <ng-template let-concept pTemplate="selectedItem">
            <span style="margin-right:1.2em;">
              <span>
                {{ concept.prefLabel | lang }}
              </span>
              <span style="opacity:.4">
                ({{ concept.conceptScheme.prefLabel | lang }})
              </span>
            </span>
          </ng-template>
        </p-autoComplete>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="freeConcepts">{{ 'freeConcepts' | translate }}</label>
        <p-chips [(ngModel)]="freeConcepts"
           inputId="freeConcepts">
        </p-chips>
        <p class="help-block">{{ 'freeConceptsHelpText' | translate }}</p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-6 col-md-4">
      <div class="form-group">
        <label for="referencePeriodStart">{{ 'referencePeriodStart' | translate }}</label>
        <iso-datepicker
          [(dateAsString)]="instanceVariable.referencePeriodStart"
          id="referencePeriodStart"
          name="referencePeriodStart">
        </iso-datepicker>
      </div>
    </div>
    <div class="col-sm-6 col-md-4">
      <div class="form-group">
        <label for="referencePeriodEnd">{{ 'referencePeriodEnd' | translate }}</label>
        <iso-datepicker
          [(dateAsString)]="instanceVariable.referencePeriodEnd"
          id="referencePeriodEnd"
          name="referencePeriodEnd">
        </iso-datepicker>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-6 col-md-4">
      <div class="form-group">
        <label for="value-domain-type">{{ 'valueDomainType.label' | translate }}</label>
        <div id="value-domain-type" class="radio">
          <label>
            <input [(ngModel)]="instanceVariable.valueDomainType" name="value-domain-type" type="radio" value="described">
            {{ 'valueDomainType.described' | translate }}
          </label>
        </div>
        <div class="radio">
          <label>
            <input [(ngModel)]="instanceVariable.valueDomainType" name="value-domain-type" type="radio" value="enumerated">
            {{ 'valueDomainType.enumerated' | translate }}
          </label>
        </div>
      </div>
    </div>
  </div>

  <ng-container *ngIf="instanceVariable.valueDomainType == 'described'">
    <ng-container *ngIf="allQuantityItems.length">
      <div class="row">
        <div class="col-xs-12">
          <div class="form-group">
            <label>{{ 'quantity' | translate }}</label>
            <br>
            <p-dropdown [(ngModel)]="instanceVariable.quantity"
                        [options]="allQuantityItems"
                        filter="true">
            </p-dropdown>
            <button
              (click)="toggleAddQuantityModal()"
              class="btn btn-default btn-sm">
              <span class="glyphicon glyphicon-plus"></span>
              {{ 'addQuantity' | translate }}
            </button>
          </div>
        </div>
      </div>
      <p-dialog [(visible)]="showAddQuantityModal"
                modal="modal"
                draggable="false"
                resizable="false"
                closeOnEscape="false"
                width="500">
        <p-header>
          {{ 'newQuantity' | translate }}
        </p-header>
        <div class="form-group">
          <label for="quantity-prefLabel">{{ 'prefLabel' | translate }}</label>
          <input [(ngModel)]="newQuantity.prefLabel[language]"
                 id="quantity-prefLabel"
                 name="quantity-prefLabel"
                 type="text"
                 class="form-control">
        </div>
        <p-footer>
          <div>
            <button (click)="saveQuantity()"
                    class="btn btn-primary">
              <span class="glyphicon glyphicon-floppy-disk"></span>
              {{ 'save' | translate }}
            </button>
            <button (click)="toggleAddQuantityModal()" class="btn btn-default">
              {{ 'cancel' | translate }}
            </button>
          </div>
        </p-footer>
      </p-dialog>
    </ng-container>
    <ng-container *ngIf="allUnitItems.length">
      <div class="row">
        <div class="col-xs-12">
          <div class="form-group">
            <label>{{ 'unit' | translate }}</label>
            <br>
            <p-dropdown [(ngModel)]="instanceVariable.unit"
                        [options]="allUnitItems"
                        filter="true">
            </p-dropdown>
            <button
              (click)="toggleAddUnitModal()"
              class="btn btn-default btn-sm">
              <span class="glyphicon glyphicon-plus"></span>
              {{ 'addUnit' | translate }}
            </button>
          </div>
        </div>
      </div>
      <p-dialog [(visible)]="showAddUnitModal"
                modal="modal"
                draggable="false"
                resizable="false"
                closeOnEscape="false"
                width="500">
        <p-header>
          {{ 'newUnit' | translate }}
        </p-header>
        <div class="form-group">
          <label for="unit-prefLabel">{{ 'prefLabel' | translate }}</label>
          <input [(ngModel)]="newUnit.prefLabel[language]"
                 id="unit-prefLabel"
                 name="unit-prefLabel"
                 type="text"
                 class="form-control">
        </div>
        <div class="form-group">
          <label for="unit-symbol">{{ 'symbol' | translate }}</label>
          <input [(ngModel)]="newUnit.symbol[language]"
                 id="unit-symbol"
                 name="unit-symbol"
                 type="text"
                 class="form-control"
                 style="width:6em;">
        </div>
        <p-footer>
          <div>
            <button (click)="saveUnit()"
              class="btn btn-primary">
              <span class="glyphicon glyphicon-floppy-disk"></span>
              {{ 'save' | translate }}
            </button>
            <button (click)="toggleAddUnitModal()" class="btn btn-default">
              {{ 'cancel' | translate }}
            </button>
          </div>
        </p-footer>
      </p-dialog>
    </ng-container>
  </ng-container>

</ng-container>

<ng-template #loadingInstanceVariable>
  <thl-spinner></thl-spinner>
</ng-template>

<div class="row">
  <div class="col-xs-12">
    <hr>
  </div>
</div>

<div class="row">
  <div class="col-xs-12">
    <div>
      <button (click)="goBack()"
              [disabled]="savingInProgress"
              class="btn btn-default">
        <span class="glyphicon glyphicon-chevron-left"></span>
        {{ 'cancel' | translate }}
      </button>

      <ng-container *ngIf="instanceVariable">
        <button (click)="saveInstanceVariable()"
          [disabled]="savingInProgress"
          class="btn btn-primary">
          <span class="glyphicon glyphicon-floppy-disk"></span>
          {{ 'save' | translate }}
        </button>

        <button *ngIf="instanceVariable.id"
          (click)="confirmRemove()"
          [disabled]="savingInProgress"
          class="btn btn-danger pull-right">
          <span class="glyphicon glyphicon-remove"></span>
          {{ 'remove' | translate }}
        </button>
      </ng-container>
    </div>
  </div>
</div>
