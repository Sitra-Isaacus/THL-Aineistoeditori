<ng-container *ngIf="dataset; else loadingInstanceVariables;">

  <study-sidebar [study]="study"
                 [activeSection]="sidebarActiveSection">
  </study-sidebar>

  <div class="content-container">

    <dataset-header [dataset]="dataset">
    </dataset-header>

    <div class="content-body container-fluid">

      <dataset-tabs [study]="study"
                    [dataset]="dataset">
      </dataset-tabs>

      <div class="row" style="margin-bottom: 1em;">
        <div class="col-xs-12">
          <div class="pull-right">
            <button routerLink="/editor/studies/{{ study.id }}/datasets/{{ dataset.id }}/instanceVariables/new"
                    class="btn btn-default">
              <span class="glyphicon glyphicon-plus"></span>
              {{ 'addInstanceVariable' | translate }}
            </button>
            <button (click)="showImportInstanceVariablesModal()"
                    class="btn btn-default btn-sm"
                    pTooltip="{{'importInstanceVariablesAsCsvTooltip' | translate}}" tooltipPosition="bottom">
              <i class="fa fa-upload" aria-hidden="true"></i>
              {{ 'importInstanceVariablesAsCsvButton' | translate }}
            </button>
            <a  *ngIf="(dataset.instanceVariables && dataset.instanceVariables.length)"
                class="btn btn-default btn-sm"
                href="{{composeInstanceVariableExportUrl()}}"
                pTooltip="{{'exportInstanceVariablesAsCsvTooltip' | translate}}"
                tooltipPosition="bottom">
              <i class="fa fa-download" aria-hidden="true"></i>
              {{ 'exportInstanceVariablesAsCsvButton' | translate }}
            </a>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-xs-12">

          <table *ngIf="(dataset.instanceVariables && dataset.instanceVariables.length); else noInstanceVariables;"
                 class="table table-striped table-hover">
            <tr>
              <th>{{ 'prefLabel' | translate }}</th>
              <th>{{ 'description' | translate }}</th>
              <th>{{ 'referencePeriod' | translate }}</th>
              <th>{{ 'functions' | translate }}</th>
            </tr>
            <tr *ngFor="let variable of dataset.instanceVariables"
                routerLink="/editor/studies/{{ study.id }}/datasets/{{ dataset.id }}/instanceVariables/{{ variable.id }}"
                style="cursor: pointer;">
              <td>
                <a routerLink="/editor/studies/{{ study.id }}/datasets/{{ dataset.id }}/instanceVariables/{{ variable.id }}">{{ variable.prefLabel | lang }}</a>
              </td>
              <td>
                <span class="preserve-line-breaks">{{ variable.description | lang }}</span>
              </td>
              <td>
                <ng-container *ngIf="(variable.referencePeriodStart || variable.referencePeriodEnd); else datasetReferencePeriod;">
                  <em>
                    {{ variable.referencePeriodStart | date:'dd.MM.yyyy' }}
                    —
                    {{ variable.referencePeriodEnd | date:'dd.MM.yyyy' }}
                  </em>
                </ng-container>
                <ng-template #datasetReferencePeriod>
                  <ng-container *ngIf="(dataset.referencePeriodStart || dataset.referencePeriodEnd); else studyReferencePeriod">
                    {{ dataset.referencePeriodStart | date:'dd.MM.yyyy' }}
                    —
                    {{ dataset.referencePeriodEnd | date:'dd.MM.yyyy' }}
                  </ng-container>
                  <ng-template #studyReferencePeriod>
                    <ng-container *ngIf="(study.referencePeriodStart || study.referencePeriodEnd)">
                      {{ study.referencePeriodStart | date:'dd.MM.yyyy' }}
                      —
                      {{ study.referencePeriodEnd | date:'dd.MM.yyyy' }}
                    </ng-container>
                  </ng-template>
                </ng-template>
              </td>
              <td>
                <button routerLink="/editor/studies/{{ study.id }}/datasets/{{ dataset.id }}/instanceVariables/{{ variable.id }}/edit"
                        class="btn btn-default btn-sm">
                  <span class="glyphicon glyphicon-pencil"></span>
                  {{ 'edit' | translate }}
                </button>
              </td>
            </tr>
          </table>

          <ng-template #noInstanceVariables>
            <p>{{ 'noInstanceVariables' | translate }}</p>
          </ng-template>

          <div class="row" style="margin-bottom: 1em;">
            <div class="col-xs-12">
              <div class="pull-right">
                <button routerLink="/editor/studies/{{ study.id }}/datasets/{{ dataset.id }}/instanceVariables/new"
                        class="btn btn-default">
                  <span class="glyphicon glyphicon-plus"></span>
                  {{ 'addInstanceVariable' | translate }}
                </button>
                <button (click)="showImportInstanceVariablesModal()"
                        class="btn btn-default btn-sm"
                        pTooltip="{{'importInstanceVariablesAsCsvTooltip' | translate}}"
                        tooltipPosition="bottom">
                  <i class="fa fa-upload" aria-hidden="true"></i>
                  {{ 'importInstanceVariablesAsCsvButton' | translate }}
                </button>
                <a  *ngIf="(dataset.instanceVariables && dataset.instanceVariables.length)"
                    class="btn btn-default btn-sm"
                    href="{{composeInstanceVariableExportUrl()}}"
                    pTooltip="{{'exportInstanceVariablesAsCsvTooltip' | translate}}"
                    tooltipPosition="bottom">
                  <i class="fa fa-download" aria-hidden="true"></i>
                  {{ 'exportInstanceVariablesAsCsvButton' | translate }}
                </a>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <instance-variables-import-modal
    [study]="studyForImportInstanceVariablesModal"
    [dataset]="datasetForImportInstanceVariablesModal"
    (onImport)="getStudyAndDataset(); closeImportInstanceVariablesModal()"
    (onCancel)="closeImportInstanceVariablesModal()">
  </instance-variables-import-modal>

</ng-container>

<ng-template #loadingInstanceVariables>
  <thl-spinner></thl-spinner>
</ng-template>
